# Build ICU 78.2 + PyICU 2.16 wheels for icukit-pyicu

name: Build

env:
  ICU_VERSION: "78.2"
  PYICU_VERSION: "2.16"

on:
  workflow_dispatch:
  push:
    branches: [main]
    tags: ['v*']
  release:
    types: [published]

jobs:
  build:
    name: ${{ matrix.os }} py${{ matrix.python }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - {runner: macos-14, os: macos-arm64, python: '3.9'}
          - {runner: macos-14, os: macos-arm64, python: '3.10'}
          - {runner: macos-14, os: macos-arm64, python: '3.11'}
          - {runner: macos-14, os: macos-arm64, python: '3.12'}
          - {runner: macos-14, os: macos-arm64, python: '3.13'}
          - {runner: macos-14, os: macos-arm64, python: '3.14'}
          - {runner: ubuntu-latest, os: linux, python: '3.9'}
          - {runner: ubuntu-latest, os: linux, python: '3.10'}
          - {runner: ubuntu-latest, os: linux, python: '3.11'}
          - {runner: ubuntu-latest, os: linux, python: '3.12'}
          - {runner: ubuntu-latest, os: linux, python: '3.13'}
          - {runner: ubuntu-latest, os: linux, python: '3.14'}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install tools
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y patchelf pkg-config build-essential unzip
          fi
          pip install --upgrade pip setuptools wheel build delocate auditwheel

      - name: Build ICU from source
        run: |
          # ICU 78+ uses release-X.Y tags and icu4c-X.Y-sources.tgz naming
          URL="https://github.com/unicode-org/icu/releases/download/release-${{ env.ICU_VERSION }}/icu4c-${{ env.ICU_VERSION }}-sources.tgz"
          echo "Downloading ICU from $URL"
          curl -L "$URL" -o icu.tgz
          tar xzf icu.tgz
          
          cd icu/source
          
          # Enable static and shared, but disable samples/tests to save time
          OS_NAME=$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')
          if [ "$OS_NAME" = "macos" ]; then
            # Use headerpad_max_install_names so delocate can rewrite IDs on macOS
            export LDFLAGS="-Wl,-headerpad_max_install_names"
            ./runConfigureICU MacOSX --prefix=/tmp/icu-dist --enable-static --enable-shared --disable-samples --disable-tests
          else
            ./configure --prefix=/tmp/icu-dist --enable-static --enable-shared --disable-samples --disable-tests
          fi
          
          make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)
          make install
          
          echo "PKG_CONFIG_PATH=/tmp/icu-dist/lib/pkgconfig" >> $GITHUB_ENV
          echo "ICU_DIST=/tmp/icu-dist" >> $GITHUB_ENV
          echo "/tmp/icu-dist/bin" >> $GITHUB_PATH
          echo "/tmp/icu-dist/sbin" >> $GITHUB_PATH

      - name: Build PyICU
        env:
          CXXFLAGS: -std=c++17
          CPPFLAGS: -I/tmp/icu-dist/include
        run: |
          set -x
          
          # Debug: show what ICU tools will provide
          echo "=== icu-config --ldflags ==="
          /tmp/icu-dist/bin/icu-config --ldflags
          
          pip download "PyICU==${{ env.PYICU_VERSION }}" --no-deps --no-binary :all: -d /tmp/src
          cd /tmp/src
          tar xzf *.tar.gz
          cd "pyicu-${{ env.PYICU_VERSION }}"
          
          # Let PyICU use icu-config for detection (already in PATH)
          export ICU_VERSION="${{ env.ICU_VERSION }}"
          
          if [ "${{ runner.os }}" = "macOS" ]; then
            # macOS: explicitly set LDFLAGS since -undefined dynamic_lookup causes issues
            export LDFLAGS="-L/tmp/icu-dist/lib -licui18n -licuuc -licudata -Wl,-headerpad_max_install_names"
            # Force single-arch build to match our ICU libs (not universal2)
            ARCH=$(uname -m)
            export ARCHFLAGS="-arch ${ARCH}"
            export _PYTHON_HOST_PLATFORM="macosx-11.0-${ARCH}"
          fi
          # Linux: Don't set LDFLAGS - it prepends flags in wrong order for GNU ld
          # PyICU will use icu-config which outputs flags in correct order
          
          pip wheel . --no-deps -w /tmp/raw -v 2>&1 | tee /tmp/pyicu-build.log
          
          # Show the linker command and verify -l flags come after .o files
          echo "=== Linker commands ==="
          grep -E "g\+\+|clang\+\+" /tmp/pyicu-build.log | grep -E "\.so" || echo "No linker commands found"
          
          # Check if ICU is linked
          echo "=== ldd on built .so ==="
          find /tmp/raw -name "*.whl" -exec unzip -o {} "icu/*.so" -d /tmp/rawcheck \;
          ldd /tmp/rawcheck/icu/*.so || true

      - name: Bundle (macOS)
        if: runner.os == 'macOS'
        run: |
          export DYLD_LIBRARY_PATH="/tmp/icu-dist/lib"
          # Use --require-archs to match the runner architecture
          ARCH=$(uname -m)
          delocate-wheel -v --require-archs "${ARCH}" -w /tmp/bundled /tmp/raw/*.whl
          mkdir /tmp/pkg && cd /tmp/pkg && unzip /tmp/bundled/*.whl

      - name: Bundle (Linux)
        if: runner.os == 'Linux'
        run: |
          # Set LD_LIBRARY_PATH so auditwheel can find ICU libraries
          export LD_LIBRARY_PATH="/tmp/icu-dist/lib:${LD_LIBRARY_PATH:-}"
          
          # Show what auditwheel sees in the raw wheel
          echo "=== auditwheel show (before repair) ==="
          auditwheel show /tmp/raw/*.whl
          
          # Check external deps with ldd
          echo "=== ldd on _icu_.so ==="
          cd /tmp/raw && unzip -l *.whl
          unzip -o *.whl "icu/*.so" -d /tmp/rawpkg
          ldd /tmp/rawpkg/icu/*.so | grep -i icu || echo "No ICU deps found by ldd"
          
          # Use manylinux_2_38 to match ubuntu-24.04 glibc
          auditwheel repair --plat manylinux_2_38_x86_64 -w /tmp/bundled /tmp/raw/*.whl
          mkdir /tmp/pkg && cd /tmp/pkg && unzip /tmp/bundled/*.whl

      - name: Build wheel
        run: |
          # 1. Copy PyICU runtime (icu/ package and bundled libs)
          rm -rf icu
          cp -R /tmp/pkg/icu .
          # Debug: show what auditwheel/delocate created
          echo "Contents of /tmp/pkg:"
          ls -la /tmp/pkg/
          echo "Contents of /tmp/pkg/icu:"
          ls -la /tmp/pkg/icu/
          # Copy bundled libs INTO icu package (so they're included in wheel)
          # auditwheel creates pyicu.libs/ at wheel root, we move into icu/.libs/
          if [ -d /tmp/pkg/pyicu.libs ]; then
            mkdir -p icu/.libs
            cp -R /tmp/pkg/pyicu.libs/* icu/.libs/
            # Fix rpath to point to .libs relative to the .so
            for so in icu/*.so; do
              if [ -f "$so" ]; then
                patchelf --set-rpath '$ORIGIN/.libs' "$so"
                echo "Fixed rpath for $so"
              fi
            done
            ls -la icu/.libs/
          fi
          # macOS uses .dylibs inside the package already (delocate does this)
          [ -d /tmp/pkg/icu/.dylibs ] && echo "Found icu/.dylibs (macOS)" || true

          # 2. Bundle ICU dev files from our /tmp/icu-dist
          mkdir -p icukit_pyicu/include icukit_pyicu/lib icukit_pyicu/bin
          cp -R /tmp/icu-dist/include/ icukit_pyicu/include/
          cp -R /tmp/icu-dist/lib/ icukit_pyicu/lib/
          cp -R /tmp/icu-dist/bin/ icukit_pyicu/bin/

          # 3. Set version dynamically
          sed "s/^version = .*/version = \"${{ env.ICU_VERSION }}.0\"/" pyproject.toml > pyproject.toml.new && mv pyproject.toml.new pyproject.toml

          python -m build --wheel
          
          # Add platform-specific tags to the wheel
          pip install wheel
          PYVER=$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
          if [ "${{ runner.os }}" = "macOS" ]; then
            PLAT="macosx_11_0_arm64"
          else
            PLAT="manylinux_2_38_x86_64"
          fi
          cd dist
          for whl in *.whl; do
            wheel tags --python-tag="${PYVER}" --abi-tag="${PYVER}" --platform-tag="${PLAT}" "$whl"
            rm "$whl"  # Remove the untagged wheel
          done
          cd ..
          
          # Linux: run auditwheel repair on final wheel to fix rpath
          if [ "${{ runner.os }}" = "Linux" ]; then
            export LD_LIBRARY_PATH="/tmp/icu-dist/lib:${LD_LIBRARY_PATH:-}"
            mkdir -p dist-repaired
            auditwheel repair --plat manylinux_2_38_x86_64 -w dist-repaired dist/*.whl
            rm dist/*.whl
            mv dist-repaired/*.whl dist/
            rmdir dist-repaired
            
            # Verify rpath is set correctly
            echo "=== Verifying rpath in final wheel ==="
            cd dist && unzip -q *.whl -d /tmp/verify-wheel
            readelf -d /tmp/verify-wheel/icu/*.so | grep -i runpath || echo "No RUNPATH found"
            cd ..
          fi

      - name: Test
        run: |
          pip install dist/*.whl
          rm -rf icu
          
          # Run test suite (no LD_LIBRARY_PATH needed - auditwheel sets rpath)
          pip install pytest
          python -m pytest tests/ -v

      - uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-py${{ matrix.python }}
          path: dist/*.whl

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    environment: pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: wheel-*
          merge-multiple: true
          path: dist
      - uses: pypa/gh-action-pypi-publish@release/v1