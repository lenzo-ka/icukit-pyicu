# Build ICU 78.2 + PyICU 2.16 wheels for icukit-pyicu

name: Build

env:
  ICU_VERSION: "78.2"
  PYICU_VERSION: "2.16"

on:
  workflow_dispatch:
  push:
    branches: [main]
    tags: ['v*']
  release:
    types: [published]

jobs:
  build:
    name: ${{ matrix.os }} py${{ matrix.python }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - {runner: macos-14, os: macos-arm64, python: '3.9'}
          - {runner: macos-14, os: macos-arm64, python: '3.10'}
          - {runner: macos-14, os: macos-arm64, python: '3.11'}
          - {runner: macos-14, os: macos-arm64, python: '3.12'}
          - {runner: macos-14, os: macos-arm64, python: '3.13'}
          - {runner: macos-14, os: macos-arm64, python: '3.14'}
          - {runner: ubuntu-22.04, os: linux, python: '3.9'}
          - {runner: ubuntu-22.04, os: linux, python: '3.10'}
          - {runner: ubuntu-22.04, os: linux, python: '3.11'}
          - {runner: ubuntu-22.04, os: linux, python: '3.12'}
          - {runner: ubuntu-22.04, os: linux, python: '3.13'}
          - {runner: ubuntu-22.04, os: linux, python: '3.14'}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install tools
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            sudo apt-get update
            sudo apt-get install -y patchelf pkg-config build-essential unzip
          fi
          pip install --upgrade pip setuptools wheel build delocate auditwheel

      - name: Build ICU from source
        run: |
          # ICU 78+ uses release-X.Y tags and icu4c-X.Y-sources.tgz naming
          URL="https://github.com/unicode-org/icu/releases/download/release-${{ env.ICU_VERSION }}/icu4c-${{ env.ICU_VERSION }}-sources.tgz"
          echo "Downloading ICU from $URL"
          curl -L "$URL" -o icu.tgz
          tar xzf icu.tgz
          
          cd icu/source
          
          # Enable static and shared, but disable samples/tests to save time
          OS_NAME=$(echo "${{ runner.os }}" | tr '[:upper:]' '[:lower:]')
          if [ "$OS_NAME" = "macos" ]; then
            # Use headerpad_max_install_names so delocate can rewrite IDs on macOS
            export LDFLAGS="-Wl,-headerpad_max_install_names"
            ./runConfigureICU MacOSX --prefix=/tmp/icu-dist --enable-static --enable-shared --disable-samples --disable-tests
          else
            ./configure --prefix=/tmp/icu-dist --enable-static --enable-shared --disable-samples --disable-tests
          fi
          
          make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu)
          make install
          
          echo "PKG_CONFIG_PATH=/tmp/icu-dist/lib/pkgconfig" >> $GITHUB_ENV
          echo "ICU_DIST=/tmp/icu-dist" >> $GITHUB_ENV
          echo "/tmp/icu-dist/bin" >> $GITHUB_PATH
          echo "/tmp/icu-dist/sbin" >> $GITHUB_PATH

      - name: Build PyICU
        env:
          CXXFLAGS: -std=c++17
          CPPFLAGS: -I/tmp/icu-dist/include
        run: |
          set -x
          
          # Debug: show what ICU tools will provide
          echo "=== icu-config --ldflags ==="
          /tmp/icu-dist/bin/icu-config --ldflags
          
          pip download "PyICU==${{ env.PYICU_VERSION }}" --no-deps --no-binary :all: -d /tmp/src
          cd /tmp/src
          tar xzf *.tar.gz
          cd "pyicu-${{ env.PYICU_VERSION }}"
          
          # Let PyICU use icu-config for detection (already in PATH)
          export ICU_VERSION="${{ env.ICU_VERSION }}"
          
          if [ "${{ runner.os }}" = "macOS" ]; then
            # macOS: explicitly set LDFLAGS since -undefined dynamic_lookup causes issues
            export LDFLAGS="-L/tmp/icu-dist/lib -licui18n -licuuc -licudata -Wl,-headerpad_max_install_names"
            # Force single-arch build to match our ICU libs (not universal2)
            ARCH=$(uname -m)
            export ARCHFLAGS="-arch ${ARCH}"
            export _PYTHON_HOST_PLATFORM="macosx-11.0-${ARCH}"
          fi
          # Linux: Don't set LDFLAGS - it prepends flags in wrong order for GNU ld
          # PyICU will use icu-config which outputs flags in correct order
          
          pip wheel . --no-deps -w /tmp/raw -v 2>&1 | tee /tmp/pyicu-build.log
          
          # Show the linker command and verify -l flags come after .o files
          echo "=== Linker commands ==="
          grep -E "g\+\+|clang\+\+" /tmp/pyicu-build.log | grep -E "\.so" || echo "No linker commands found"
          
          # Check if ICU is linked
          echo "=== ldd on built .so ==="
          find /tmp/raw -name "*.whl" -exec unzip -o {} "icu/*.so" -d /tmp/rawcheck \;
          ldd /tmp/rawcheck/icu/*.so || true

      - name: Bundle (macOS)
        if: runner.os == 'macOS'
        run: |
          export DYLD_LIBRARY_PATH="/tmp/icu-dist/lib"
          # Use --require-archs to match the runner architecture
          ARCH=$(uname -m)
          delocate-wheel -v --require-archs "${ARCH}" -w /tmp/bundled /tmp/raw/*.whl
          mkdir /tmp/pkg && cd /tmp/pkg && unzip /tmp/bundled/*.whl

      - name: Bundle (Linux)
        if: runner.os == 'Linux'
        run: |
          # Set LD_LIBRARY_PATH so auditwheel can find ICU libraries
          export LD_LIBRARY_PATH="/tmp/icu-dist/lib:${LD_LIBRARY_PATH:-}"
          
          # Show what auditwheel sees in the raw wheel
          echo "=== auditwheel show (before repair) ==="
          auditwheel show /tmp/raw/*.whl
          
          # Check external deps with ldd
          echo "=== ldd on _icu_.so ==="
          cd /tmp/raw && unzip -l *.whl
          unzip -o *.whl "icu/*.so" -d /tmp/rawpkg
          ldd /tmp/rawpkg/icu/*.so | grep -i icu || echo "No ICU deps found by ldd"
          
          # Use manylinux_2_35 to match ubuntu-22.04 glibc
          auditwheel repair --plat manylinux_2_35_x86_64 -w /tmp/bundled /tmp/raw/*.whl
          mkdir /tmp/pkg && cd /tmp/pkg && unzip /tmp/bundled/*.whl

      - name: Build wheel
        run: |
          # Instead of rebuilding with setuptools (which loses rpath),
          # directly modify the auditwheel-repaired wheel to add icukit_pyicu
          
          PYVER=$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
          if [ "${{ runner.os }}" = "macOS" ]; then
            PLAT="macosx_11_0_arm64"
          else
            PLAT="manylinux_2_35_x86_64"
          fi
          
          # Get the bundled wheel from auditwheel/delocate
          BUNDLED_WHL=$(ls /tmp/bundled/*.whl)
          echo "Working with: $BUNDLED_WHL"
          
          # Create working directory
          mkdir -p /tmp/wheel-work
          cd /tmp/wheel-work
          unzip -q "$BUNDLED_WHL"
          
          # Show what auditwheel created (for debugging)
          echo "=== Wheel contents ==="
          find . -type f | head -20
          
          # Verify rpath is set correctly by auditwheel
          if [ "${{ runner.os }}" = "Linux" ]; then
            echo "=== Checking rpath ==="
            readelf -d icu/*.so | grep -i runpath || echo "No RUNPATH found"
          fi
          
          # Add icukit_pyicu package with ICU dev files
          mkdir -p icukit_pyicu/include icukit_pyicu/lib icukit_pyicu/bin
          cp -R /tmp/icu-dist/include/* icukit_pyicu/include/
          cp -R /tmp/icu-dist/lib/* icukit_pyicu/lib/
          cp -R /tmp/icu-dist/bin/* icukit_pyicu/bin/
          
          # Copy icukit_pyicu Python files from repo
          cp $GITHUB_WORKSPACE/icukit_pyicu/__init__.py icukit_pyicu/
          cp $GITHUB_WORKSPACE/icukit_pyicu/__main__.py icukit_pyicu/
          
          # Update the dist-info to reflect our package name
          OLD_DIST=$(ls -d *.dist-info)
          NEW_DIST="icukit_pyicu-78.2.1.dist-info"
          mv "$OLD_DIST" "$NEW_DIST"
          
          # Update METADATA
          cat > "$NEW_DIST/METADATA" << 'EOF'
          Metadata-Version: 2.1
          Name: icukit-pyicu
          Version: 78.2.1
          Summary: Bundled ICU and PyICU for pip
          Author: Kevin A. Lenzo
          Author-email: keinlenzo@gmail.com
          License: MIT
          Project-URL: Homepage, https://github.com/lenzo-ka/icukit-pyicu
          Keywords: icu,unicode,i18n,pyicu
          Classifier: Development Status :: 5 - Production/Stable
          Classifier: Intended Audience :: Developers
          Classifier: License :: OSI Approved :: MIT License
          Classifier: Operating System :: MacOS
          Classifier: Operating System :: POSIX :: Linux
          Classifier: Programming Language :: Python :: 3
          Requires-Python: >=3.9
          Description-Content-Type: text/markdown
          
          # icukit-pyicu
          
          Bundled ICU and PyICU for easy pip installation.
          EOF
          # Remove leading spaces from heredoc (use temp file for portability)
          sed 's/^          //' "$NEW_DIST/METADATA" > "$NEW_DIST/METADATA.tmp" && mv "$NEW_DIST/METADATA.tmp" "$NEW_DIST/METADATA"
          
          # Update WHEEL file
          cat > "$NEW_DIST/WHEEL" << EOF
          Wheel-Version: 1.0
          Generator: icukit-pyicu-build
          Root-Is-Purelib: false
          Tag: ${PYVER}-${PYVER}-${PLAT}
          EOF
          
          # Update top_level.txt
          echo -e "icu\nicukit_pyicu" > "$NEW_DIST/top_level.txt"
          
          # Add entry_points.txt for CLI
          cat > "$NEW_DIST/entry_points.txt" << 'EOF'
          [console_scripts]
          icukit-config = icukit_pyicu.__main__:main
          EOF
          
          # Regenerate RECORD (list of files with hashes)
          python3 << 'PYTHON'
          import hashlib
          import base64
          import os
          
          def file_hash(path):
              with open(path, 'rb') as f:
                  digest = hashlib.sha256(f.read()).digest()
              return 'sha256=' + base64.urlsafe_b64encode(digest).rstrip(b'=').decode()
          
          def file_size(path):
              return os.path.getsize(path)
          
          records = []
          for root, dirs, files in os.walk('.'):
              for f in files:
                  path = os.path.join(root, f)[2:]  # Remove ./
                  if path.endswith('RECORD'):
                      records.append(f'{path},,')
                  else:
                      records.append(f'{path},{file_hash(path)},{file_size(path)}')
          
          # Find the dist-info directory
          dist_info = [d for d in os.listdir('.') if d.endswith('.dist-info')][0]
          with open(f'{dist_info}/RECORD', 'w') as f:
              f.write('\n'.join(sorted(records)) + '\n')
          PYTHON
          
          # Create the final wheel
          mkdir -p $GITHUB_WORKSPACE/dist
          WHEEL_NAME="icukit_pyicu-78.2.1-${PYVER}-${PYVER}-${PLAT}.whl"
          zip -rq "$GITHUB_WORKSPACE/dist/$WHEEL_NAME" .
          
          echo "Created: $WHEEL_NAME"
          ls -la $GITHUB_WORKSPACE/dist/

      - name: Test
        run: |
          pip install dist/*.whl
          rm -rf icu
          
          # No LD_LIBRARY_PATH needed - rpath is preserved from auditwheel
          pip install pytest
          python -m pytest tests/ -v

      - uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-py${{ matrix.python }}
          path: dist/*.whl

  publish:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    environment: pypi
    permissions:
      id-token: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: wheel-*
          merge-multiple: true
          path: dist
      - uses: pypa/gh-action-pypi-publish@release/v1